#vamos testar assim temos so o ipv4 o catch e o ler as vms da lista - this one worked

# Import Excel module
Import-Module ImportExcel

# Read VMs from Excel
$vms = Import-Excel -Path "C:\Path\To\VMList.xlsx" | Select-Object -ExpandProperty VMName

# Create a credential object
$credential = New-Object System.Management.Automation.PSCredential (
    "$env:USERDOMAIN\$env:USERNAME",
    (Get-Credential -UserName "$env:USERDOMAIN\$env:USERNAME" -Message "Please enter your password").Password
)

# To collect unreachable VMs
$failedVMs = @()

foreach ($vm in $vms) {
    try {
        $result = Invoke-Command -ComputerName $vm -ScriptBlock {
            $hostname = hostname
            $ipv4 = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {
                $_.IPAddress -ne "127.0.0.1" -and $_.InterfaceAlias -notmatch "Loopback"
            }).IPAddress

            return "Hostname: $hostname`nIPv4 Address(es): $($ipv4 -join ", ")"
        } -Credential $credential -ErrorAction Stop

        Write-Host "----------------------"
        Write-Host "Result from $vm :"
        Write-Host "----------------------"
        Write-Host $result
        Write-Host "----------------------`n"
    }
    catch {
        Write-Warning "Could not retrieve info from $vm"
        $failedVMs += $vm
    }
}

# Show list of failed VMs
if ($failedVMs.Count -gt 0) {
    Write-Host "`n======================="
    Write-Host "FAILED TO CONNECT TO:"
    Write-Host "======================="
    $failedVMs | ForEach-Object { Write-Host $_ }
}





















# Import the module
Import-Module Posh-SSH

# Read VM list
$linuxVMs = Get-Content -Path "C:\Path\To\LinuxVMs.txt"

# Prompt for SSH credentials
$cred = Get-Credential -Message "Enter Linux SSH credentials"

# Track failed VMs
$failedVMs = @()

foreach ($vm in $linuxVMs) {
    try {
        # Create SSH session
        $session = New-SSHSession -ComputerName $vm -Credential $cred -AcceptKey -ErrorAction Stop

        # Run remote commands
        $hostname = Invoke-SSHCommand -SessionId $session.SessionId -Command "hostname"
        $ipv4 = Invoke-SSHCommand -SessionId $session.SessionId -Command "ip -4 addr show | grep inet | grep -v 127.0.0.1 | awk '{print $2}' | cut -d/ -f1"

        # Output
        Write-Host "----------------------------"
        Write-Host "Result from $vm:"
        Write-Host "Hostname: $($hostname.Output.Trim())"
        Write-Host "IPv4 Address(es): $($ipv4.Output -join ', ' -replace '\s+', '')"
        Write-Host "----------------------------`n"

        # Close session
        Remove-SSHSession -SessionId $session.SessionId
    }
    catch {
        Write-Warning "Could not connect to $vm"
        $failedVMs += $vm
    }
}

# Show failures
if ($failedVMs.Count -gt 0) {
    Write-Host "`n======================="
    Write-Host "FAILED TO CONNECT TO:"
    Write-Host "======================="
    $failedVMs | ForEach-Object { Write-Host $_ }
}
